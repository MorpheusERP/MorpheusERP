<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alterar Usuario</title>
    <link rel="stylesheet" href="../CSS/Cadastro.css">
    <script>
        //Fun√ß√£o para verificar se o usu√°rio est√° logado
    function verificarLogin() {
            fetch('../../../Backend/verificalogin.php')
                .then(response => response.json())
                .then(data => {
                    if (!data.logado) {
                        // Redireciona para a p√°gina de login se n√£o estiver logado
                        window.location.href = '../../../index.html';
                    }
                })
                .catch(error => {
                    console.error("Erro ao verificar autentica√ß√£o:", error);
                });
            }

        // Executa a fun√ß√£o quando a p√°gina √© carregada
        document.addEventListener("DOMContentLoaded", verificarLogin);
    </script>
</head>
<body>
    <div class="header">
        <h1>Cadastro</h1>
    </div>
        <div class="container">
            <div class="form">
                <div class="buttons" id="default-buttons">
                    <button class="search" onclick="window.location.href='Busca.html'">Buscar</button>
                </div>
                <div class="Conteudo">
                    <div class="buttons" id="new-button">
                        <button class="back" onclick="window.location.href='Cadastro.html'">Voltar</button>
                    </div>
                    <form id="cadastroForm">
                        <select id="nivel">
                            <option value="" disabled selected>* N√≠vel de Usu√°rio</option>
                            <option value="padrao">Padr√£o</option>
                            <option value="admin">Administrador</option>
                        </select>
                        <input type="text" id="nome" class="input-field" maxlength="20" placeholder="* Nome">
                        <input type="text" id="sobrenome" class="input-field" maxlength="20">
                        <input type="text" id="funcao" class="input-field" maxlength="20" placeholder="* Fun√ß√£o">
                        <input type="text" id="login" class="input-field" maxlength="10" placeholder="* Login">
                        <div class="input-container" id="show-password">
                            <input type="password" id="senha" class="input-field" maxlength="4" placeholder="* Senha">
                            <button type="button" id="show-password" class="toggle-visibility" onclick="togglePasswordVisibility('senha')">üëÅ</button>
                        </div>

                        <div class="buttons-edit" id="edit-buttons">
                            <button class="edit" type="submit">Salvar</button>
                        </div>
                    </form>
                    <br><br>
                        <p id="mensagemSucesso" style="font-size: 18px; background-color:green; color: whitesmoke;"></p>
                        <p id="mensagemErro" style="font-size: 18px; background-color: red;color: whitesmoke"></p>
                </div>
            </div>
        </div>


    <footer>
        <div class="BotoesFooter">
            <div class="buttons-search">
                <a href="../../../home.html">
                   <button class="search">Sair</button>
                </a>
            </div>
    </footer>
    <div class="logo">
        <img src="../Fotos/Emporio maxx s-fundo.png" alt="Emp√≥rio Maxx Logo">
    </div>

    <script>
  // Obtem o ID do usu√°rio da URL
  const params = new URLSearchParams(window.location.search);
  const id_Usuario = params.get('id_Usuario');

  // Preenche o formul√°rio com os dados do usu√°rio
  fetch(`../../../Backend/CadastroUsuario/buscarusuario.php?id_Usuario=${id_Usuario}`)
      .then(response => response.json())
      .then(data => {
          console.log(data);
          document.getElementById('nivel').value = data.nivel_Usuario;
          document.getElementById('nome').value = data.nome_Usuario;
          document.getElementById('sobrenome').value = data.sobrenome;
          document.getElementById('funcao').value = data.funcao;
          document.getElementById('login').value = data.login;

          salvarAltera√ß√µes(data, id_Usuario);
      })
      .catch(error => console.error('Erro ao carregar dados do usu√°rio:', error));

    function salvarAltera√ß√µes(data, id_Fornecedor){
     // Evento para enviar as altera√ß√µes
    document.getElementById('cadastroForm').addEventListener('submit', function(event) {
        event.preventDefault(); // Impede o envio padr√£o do formul√°rio
    
    const nivel = document.getElementById('nivel').value;
    const nome = document.getElementById('nome').value;
    const sobrenome = document.getElementById('sobrenome').value;
    const funcao = document.getElementById('funcao').value;
    const login = document.getElementById('login').value;
    const senha = document.getElementById('senha').value;

    // Verifica se algum campo foi alterado
    if (
        nivel === data.nivel_Usuario &&
        nome === data.nome_Usuario &&
        sobrenome === data.sobrenome &&
        funcao === data.funcao &&
        login === data.login &&
        senha === ""
    ) {
        // Exibe mensagem de erro se n√£o houve altera√ß√µes
        document.getElementById("mensagemErro").innerText = "Nenhuma altera√ß√£o realizada.";
        setTimeout(() => {
            document.getElementById("mensagemErro").innerText = "";
        }, 2000); // Delay de 4000 ms (4 segundos)
    } else {
      const formData = {
            id_Usuario: id_Usuario,
            nivel: nivel,
            nome: nome,
            sobrenome: sobrenome,
            funcao: funcao,
            login: login,
            senha: senha,
      };

      fetch('../../../Backend/CadastroUsuario/atualizarusuario.php', {
          method: 'POST',
          headers: {
              'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
      })
      .then(response => response.json())
      .then(data => {
          if (data.status === 'sucesso') {
            document.getElementById('mensagemSucesso').innerText = data.mensagem;
            setTimeout(() =>{
                document.getElementById('mensagemSucesso').innerText = "";
            }, 2000);
          }
          else if (data.status === 'erro'){
            // Exibe mensagem de erro se houver falha
            document.getElementById('mensagemErro').innerText = data.mensagem;
        }
      });
    }
    })
    }
    </script>

    <!--Script para exibir e ocultar a senha-->
    <script>
        function togglePasswordVisibility(id) {
            var passwordField = document.getElementById(id);
            if (passwordField.type === "password") {
                passwordField.type = "number";
            } else {
                passwordField.type = "password";
            }
        }
    </script>
</body>
</html>